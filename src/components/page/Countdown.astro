---
import ArrowRight from "@assets/desc_page/arrow_right.svg";
const { end, start, form_url } = Astro.props;
---

<div class="countdown" data-date-end={end} data-date-start={start}>
	<div class="title-bar">
		<h2 class="title">投稿截止</h2>
		<div class="progress-bar">
			<div class="progress" style="width: 99%;"></div>
		</div>
		<span class="progress-number">99%</span>
	</div>
	<div class="timer">
		<div>
			<div class="timer-number countdown-days">00</div>
			<div class="timer-text">DAYS</div>
		</div>

		<div>
			<div class="timer-number countdown-hours">00</div>
			<div class="timer-text">HOURS</div>
		</div>

		<div>
			<div class="timer-number countdown-minutes">00</div>
			<div class="timer-text">MINUTES</div>
		</div>

		<div>
			<div class="timer-number countdown-seconds">00</div>
			<div class="timer-text">SECONDS</div>
		</div>
	</div>
	<div class="footer">
		<div class="deadline">
			截止時間<br />
			{
				new Date(end).toLocaleString("zh-TW", {
					year: "numeric",
					month: "numeric",
					day: "numeric",
					weekday: "narrow",
					hour: "2-digit",
					minute: "2-digit",
					hour12: false
				})
			}
		</div>
		<a class="link" href={form_url} target="_blank" rel="noopener" aria-label="立即投稿">
			立即投稿
			<ArrowRight width="2rem" />
		</a>
	</div>
</div>

<style>
	.countdown {
		border-radius: 2rem;
		background: #566d8d;
		padding: 2rem;
	}
	.footer {
		/* TODO: @media */
		display: flex;
		justify-content: space-around;
	}
	.link {
		display: flex;
		color: #566d8d;
		font-size: 1.5rem;
		font-weight: bold;
		text-decoration: none;
		justify-content: center;
		align-items: center;
		line-height: 2rem;
		letter-spacing: 0.2rem;
		border-radius: 1.5rem;
		border: 2px solid rgba(255, 255, 255, 0.8);
		background-color: rgba(255, 255, 255, 0.8);
		gap: 0.5rem;
		flex-grow: 0.4;
	}
	.deadline {
		text-align: center;
		font-size: 1.1rem;
		line-height: 2.5rem;
		letter-spacing: 0.2rem;
		border-radius: 1.5rem;
		align-content: center;
		flex-grow: 0.4;
		border: 2px solid rgba(255, 255, 255, 0.8);
	}
	.timer {
		display: flex;
		justify-content: space-around;
		margin: 2rem 0;
		text-align: center;
	}
	.timer-number {
		font-size: 4rem;
	}
	.timer-text {
		font-size: 1rem;
	}
	.title {
		letter-spacing: 1rem;
		font-size: 2rem;
	}
	.title-bar {
		display: flex;
		align-items: center;
		gap: 0.7rem;
	}
	.progress-bar {
		flex-grow: 1;
		height: 1rem;
		background: #ffffff;
		border-radius: 1rem;
		margin: 0 1rem;
		overflow: hidden;
	}
	.progress-number {
		font-size: larger;
		letter-spacing: 0.4rem;
	}
	.progress {
		height: 100%;
		background: #86aee5;
		border-radius: 1rem 0 0 1rem;
		transition: width 0.5s ease-in-out;
	}
</style>

<script>
	const dateToCountdownNumber = (date: string) => {
		const now = new Date();
		const deadline = new Date(date);
		if (deadline <= now) {
			return {
				days: "00",
				hours: "00",
				minutes: "00",
				seconds: "00"
			};
		}
		const diff = deadline.getTime() - now.getTime();
		const days = Math.floor(diff / (1000 * 60 * 60 * 24));
		const hours = Math.floor((diff / (1000 * 60 * 60)) % 24);
		const minutes = Math.floor((diff / (1000 * 60)) % 60);
		const seconds = Math.floor((diff / 1000) % 60);
		return {
			days: String(days).padStart(2, "0"),
			hours: String(hours).padStart(2, "0"),
			minutes: String(minutes).padStart(2, "0"),
			seconds: String(seconds).padStart(2, "0")
		};
	};

	const updateCountdown = () => {
		document.querySelectorAll(".countdown").forEach(el => {
			// Update countdown numbers
			const end_string = el.getAttribute("data-date-end") || "";
			const countdown = dateToCountdownNumber(end_string);
			el.querySelector(".countdown-days")!.textContent = countdown.days;
			el.querySelector(".countdown-hours")!.textContent = countdown.hours;
			el.querySelector(".countdown-minutes")!.textContent = countdown.minutes;
			el.querySelector(".countdown-seconds")!.textContent = countdown.seconds;

			// Update progress bar
			const start_string = el.getAttribute("data-date-start") || "";
			const now = new Date();
			const deadline = new Date(end_string);
			const start = new Date(start_string);
			const total = deadline.getTime() - start.getTime();
			const elapsed = now.getTime() - start.getTime();
			const progress = Math.min(Math.max((elapsed / total) * 100, 0), 100);
			el.querySelector(".progress")!.setAttribute("style", `width: ${progress}%`);
			el.querySelector(".progress-number")!.textContent = `${Math.floor(progress)}%`;
		});
	};
	setInterval(updateCountdown, 1000);
	updateCountdown();
</script>
